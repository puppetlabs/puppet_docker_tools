#!/usr/bin/env ruby

require 'docker'

dockerfile_directory = ARGV[0] || '.'

container = Docker::Container.create('Cmd' => ['/bin/sh', '-c', "hadolint --ignore DL3008 --ignore DL4000 --ignore DL4001 - "], 'Image' => 'lukasmartinelli/hadolint', 'OpenStdin' => true, 'StdinOnce' => true)
container.tap(&:start).attach(stdin: "#{dockerfile_directory}/Dockerfile")
container.wait
exit_status = container.json['State']['ExitCode']
unless exit_status == 0
  STDERR.puts container.logs(stdout: true, stderr: true)
  exit(exit_status)
end
